---
interface TickerEvent {
  type: 'SEND' | 'CLAIM' | 'TOP_UP' | 'UPGRADE' | 'JACKPOT';
  actor?: string;
  group?: string;
  amount?: number;
  unit?: string;
  feature?: string;
}

interface GroupCardData {
  name: string;
  owner: string;
  members: number;
  totalSent: string;
  periodSent: string;
  link: string;
}

interface Props {
  botUrl: string;
  lang: string;
  claimMessages: any;
  tickerEvents: TickerEvent[];
  latestGroupsData: GroupCardData[];
  hotGroupsData: GroupCardData[];
  itemsPerPage: number;
  chatsApiUrl?: string;
}

const {
  botUrl,
  lang,
  claimMessages,
  tickerEvents,
  latestGroupsData,
  hotGroupsData,
  itemsPerPage,
  chatsApiUrl = '',
} = Astro.props as Props;

const isEN = lang === 'en-US';

// label helpers - 使用 claimMessages 中的 i18n 数据
function labelMembers(): string {
  return claimMessages?.groups?.members || '';
}
function labelTotalSent(): string {
  return claimMessages?.groups?.total_sent || '';
}
function labelThisPeriod(): string {
  return claimMessages?.groups?.period_sent || '';
}

// ticker formatter
function formatTicker(ev: TickerEvent): string {
  const tmpl = claimMessages?.ticker_templates?.[ev.type] || '';
  return tmpl
    .replace('{actor}', ev.actor ?? '')
    .replace('{group}', ev.group ?? '')
    .replace('{amount}', ev.amount !== undefined ? String(ev.amount) : '')
    .replace('{unit}', ev.unit ?? '')
    .replace('{feature}', ev.feature ?? '');
}

// 從 URL 讀初始狀態
const url = Astro.url;
const tabParam = url.searchParams.get('tab') ?? 'latest';
const pageParam = url.searchParams.get('page') ?? '1';

const initialTab = (tabParam === 'hot' ? 'hot' : 'latest') as 'latest' | 'hot';
const initialPage = Math.max(parseInt(pageParam, 10) || 1, 1);

// 初始 slice 用 latest 第 1 頁
const initialData = initialTab === 'hot' ? hotGroupsData : latestGroupsData;
const startIndex = (initialPage - 1) * itemsPerPage;
const initialSlice = initialData.slice(startIndex, startIndex + itemsPerPage);

const initialTotalItems = initialData.length;
const initialTotalPages = Math.ceil(initialTotalItems / itemsPerPage);
---

<section id="hero" class="mx-auto max-w-6xl px-4 py-6">
  <div class="flex flex-col gap-4">
    <div class="rounded-2xl bg-white ring-1 ring-black/5 shadow-sm p-0 overflow-hidden">
      <!-- 跑馬燈 -->
      <div class="relative w-full whitespace-nowrap text-sm">
        <div class="marquee flex items-center gap-8 px-4 py-2" data-marquee>
          {tickerEvents.map((ev) => <span>{formatTicker(ev)}</span>)}
        </div>
      </div>

      <!-- tabs + search -->
      <div class="flex flex-wrap items-center justify-between gap-3 px-4 pb-4 pt-3">
        <div class="inline-flex rounded-lg bg-black/5 p-1" role="tablist" aria-label="groups-sort">
          <button
            type="button"
            data-tab-btn="latest"
            class="px-3 py-1.5 rounded-md text-sm font-medium bg-white shadow"
            role="tab"
            aria-controls="group-grid"
            aria-selected="true"
          >
            {claimMessages?.tabs?.latest}
          </button>
          <button
            type="button"
            data-tab-btn="hot"
            class="px-3 py-1.5 rounded-md text-sm font-medium text-black/70"
            role="tab"
            aria-controls="group-grid"
            aria-selected="false"
          >
            {claimMessages?.tabs?.hot}
          </button>
        </div>

        <div class="flex items-center gap-2">
          <label for="q" class="sr-only">{claimMessages?.search_placeholder}</label>
          <div class="relative">
            <svg
              aria-hidden="true"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
              class="absolute left-2 top-1/2 -translate-y-1/2"
              focusable="false"
            >
              <path
                fill="#6B7280"
                d="M10 4a6 6 0 104.472 10.028l4.75 4.75 1.415-1.415-4.75-4.75A6 6 0 0010 4zm0 2a4 4 0 110 8 4 4 0 010-8z"
              ></path>
            </svg>
            <input
              id="q"
              type="search"
              inputmode="search"
              placeholder={claimMessages?.search_placeholder}
              class="w-[220px] md:w-[280px] pl-7 pr-3 py-2 rounded-md border border-black/10 bg-white text-sm outline-none focus:ring-2 focus:ring-primary/30"
            />
          </div>
        </div>
      </div>

      <!-- 卡片 grid：初始渲染 latest 第 1 頁 -->
      <div id="group-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 px-4">
        {
          initialSlice.map((g) => (
            <a
              href={g.link}
              target="_blank"
              rel="noopener noreferrer"
              class="packet block rounded-2xl overflow-hidden ring-1 ring-black/20 hover:shadow transition-shadow outline-none focus-visible:ring-2 focus-visible:ring-[#FFBA00]"
            >
              <div class="lid relative px-4 pt-3 pb-2 flex items-center justify-between">
                <div class="min-w-0">
                  <div class="flex items-center gap-2 text-sm font-semibold truncate">
                    <span>{g.name}</span>
                  </div>
                  <div
                    class="text-xs text-white/90 mt-0.5"
                    set:html={
                      claimMessages?.groups?.owner_label?.replace('{handle}', g.owner) ||
                      `${claimMessages?.groups?.owner}${g.owner}`
                    }
                  />
                </div>
                <div class="seal" aria-hidden="true" />
              </div>

              <div class="body px-4 pb-2 pt-1">
                <div class="grid grid-cols-3 gap-2 text-center">
                  <div class="stat-box rounded-md p-2">
                    <div class="text-[10px] text-white">{labelMembers()}</div>
                    <div class="num num-hero whitespace-nowrap">{g.members}</div>
                  </div>
                  <div class="stat-box rounded-md p-2">
                    <div class="text-[10px] text-white">{labelTotalSent()}</div>
                    <div class="num num-hero whitespace-nowrap">{g.totalSent}</div>
                  </div>
                  <div class="stat-box rounded-md p-2">
                    <div class="text-[10px] text-white">{labelThisPeriod()}</div>
                    <div class="num num-hero whitespace-nowrap">{g.periodSent}</div>
                  </div>
                </div>
              </div>
            </a>
          ))
        }
      </div>

      <!-- 分頁列 -->
      <div class="flex items-center justify-between mt-3 px-4 pb-4">
        <div class="text-xs text-textSubtle" data-page-info>
          {
            isEN
              ? `${initialTotalItems} groups (Page ${initialPage} / ${initialTotalPages})`
              : `共 ${initialTotalItems} 個群組｜第 ${initialPage} / ${initialTotalPages} 頁`
          }
          <span class="sr-only">{isEN ? 'Page info' : '頁面資訊'}</span>
        </div>
        <div class="inline-flex items-center gap-2">
          <button
            type="button"
            data-prev
            class="px-2 py-1 rounded border border-black/10 bg-white text-sm"
          >
            {claimMessages?.pagination?.prev || (isEN ? 'Prev' : '上一頁')}
          </button>
          <button
            type="button"
            data-next
            class="px-2 py-1 rounded border border-black/10 bg-white text-sm"
          >
            {claimMessages?.pagination?.next || (isEN ? 'Next' : '下一頁')}
          </button>
        </div>
      </div>
    </div>

    <div>
      <a
        href={botUrl}
        class="btn btn-primary inline-flex items-center gap-2"
        target="_blank"
        rel="noopener noreferrer"
      >
        {claimMessages?.cta_launch}
      </a>
    </div>
  </div>
</section>

<style>
  @keyframes marquee-x {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }
  @keyframes marquee-x-rtl {
    0% {
      transform: translateX(-50%);
    }
    100% {
      transform: translateX(0);
    }
  }
  .marquee {
    animation: marquee-x 14s linear infinite;
  }
  [dir='rtl'] .marquee {
    animation: marquee-x-rtl 14s linear infinite;
  }

  .num-hero {
    font-weight: 700;
    letter-spacing: -0.01em;
    font-size: 0.95rem;
  }
  @media (min-width: 640px) {
    .num-hero {
      font-size: 1rem;
    }
  }

  /* RTL support: search icon positioning */
  [dir='rtl'] .relative svg.absolute {
    left: auto;
    right: 0.5rem;
  }

  [dir='rtl'] .relative input[type='search'] {
    padding-left: 0.75rem;
    padding-right: 1.75rem;
  }

  /* Default: dark theme packet */
  .packet {
    background: #0c1e3a;
    color: #fff;
    box-shadow: 0 6px 16px rgba(227, 37, 33, 0.15);
  }

  /* Light theme packet */
  [data-theme='light'] .packet {
    background: #ffffff !important;
    color: #0c1e3a !important;
    box-shadow: 0 6px 16px rgba(12, 30, 58, 0.08) !important;
  }

  /* Light theme: force stat-box background and text color */
  [data-theme='light'] .packet .stat-box {
    background: rgba(12, 30, 58, 0.04) !important;
  }

  [data-theme='light'] .packet .stat-box .text-white {
    color: #6a6f76 !important;
  }

  [data-theme='light'] .packet .text-white\/90 {
    color: rgba(106, 111, 118, 0.9) !important;
  }

  /* Seal in light theme */
  [data-theme='light'] .packet .seal {
    box-shadow: 0 0 0 3px rgba(255, 186, 0, 0.2) inset !important;
  }

  .packet .lid {
    position: relative;
  }

  .packet .seal {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #ffba00;
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1) inset;
  }

  .stat-box {
    background: rgba(255, 255, 255, 0.06);
  }
</style>

<script
  is:inline
  define:vars={{ lang, latestGroupsData, hotGroupsData, itemsPerPage, claimMessages, chatsApiUrl }}
>
  (function () {
    // DOM refs
    const gridEl = document.querySelector('#group-grid');
    const pageInfoEl = document.querySelector('[data-page-info]');
    const prevBtn = document.querySelector('[data-prev]');
    const nextBtn = document.querySelector('[data-next]');
    const tabBtns = document.querySelectorAll('[data-tab-btn]');
    const searchInput = document.querySelector('#q');

    // 狀態
    let activeTab = 'latest';
    let currentPage = 1;
    let searchQuery = '';
    let isLoading = false;
    let cachedData = {
      latest: latestGroupsData || [],
      hot: hotGroupsData || [],
    };
    let totalItems = 0;

    // 從 URL 初始化
    const params = new URLSearchParams(location.search);
    const qpTab = params.get('tab');
    const qpPage = parseInt(params.get('page') || '1', 10);
    const qpQ = params.get('q') || '';
    if (qpTab === 'hot' || qpTab === 'latest') activeTab = qpTab;
    if (!Number.isNaN(qpPage)) currentPage = qpPage;
    if (qpQ && searchInput) {
      searchInput.value = qpQ;
      searchQuery = qpQ;
    }

    // 從 API 獲取數據
    async function fetchGroupsFromApi(type, page, q) {
      if (!chatsApiUrl) {
        return { data: cachedData[type] || [], total: (cachedData[type] || []).length || 0 };
      }
      try {
        const params = new URLSearchParams({
          page: String(page),
          type: type,
        });
        if (q) {
          params.set('q', q);
        }
        const response = await fetch(`${chatsApiUrl}?${params.toString()}`, {
          cache: 'no-store',
        });
        if (response.ok) {
          const result = await response.json();
          const transformed = (result.data || []).map((g) => ({
            name: g.name || '',
            owner: g.owner_username ? `@${g.owner_username}` : '',
            members: g.member_count || 0,
            totalSent: g.total_send_usdt
              ? new Intl.NumberFormat('en-US').format(Number(g.total_send_usdt))
              : '0',
            periodSent: g.current_send_usdt
              ? new Intl.NumberFormat('en-US').format(Number(g.current_send_usdt))
              : '0',
            link: g.username ? `https://t.me/${g.username}` : '',
          }));
          return { data: transformed, total: result.total || 0 };
        }
      } catch (err) {
        console.warn('[GroupsHero] Failed to fetch groups:', err);
      }
      return { data: cachedData[type] || [], total: cachedData[type]?.length || 0 };
    }

    // 工具函式
    function getSource() {
      return cachedData[activeTab] || [];
    }

    function clampPage(p) {
      const totalPages = Math.ceil(getSource().length / itemsPerPage);
      if (p < 1) return 1;
      if (p > totalPages) return totalPages;
      return p;
    }

    async function render() {
      if (isLoading) return;

      // 如果有 API URL，從 API 獲取數據
      if (chatsApiUrl) {
        isLoading = true;
        try {
          const result = await fetchGroupsFromApi(activeTab, currentPage, searchQuery || undefined);
          cachedData[activeTab] = result.data;
          totalItems = result.total;
        } finally {
          isLoading = false;
        }
      } else {
        // 使用緩存的數據
        totalItems = getSource().length;
      }

      const source = getSource();
      const totalPages = Math.ceil(totalItems / itemsPerPage);

      currentPage = Math.max(1, Math.min(currentPage, totalPages || 1));

      // 如果使用 API，直接使用返回的數據（已經是當前頁的數據）
      // 如果使用緩存數據，需要切片
      const slice = chatsApiUrl
        ? source
        : source.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

      // 1. 渲染卡片 grid
      gridEl.innerHTML = slice
        .map((g) => {
          const ownerLabel =
            claimMessages?.groups?.owner_label?.replace('{handle}', g.owner) ||
            (claimMessages?.groups?.owner || 'Owner: ') + g.owner;
          const labelMembers = claimMessages?.groups?.members || 'Members';
          const labelTotal = claimMessages?.groups?.total_sent || 'Total Sent (USDT)';
          const labelPeriod = claimMessages?.groups?.period_sent || 'This Period (USDT)';
          return `
      <a href="${g.link}" target="_blank" rel="noopener noreferrer" class="packet block rounded-2xl overflow-hidden ring-1 ring-black/20 hover:shadow transition-shadow outline-none focus-visible:ring-2 focus-visible:ring-[#FFBA00]">
        <div class="lid relative px-4 pt-3 pb-2 flex items-center justify-between">
          <div class="min-w-0">
            <div class="flex items-center gap-2 text-sm font-semibold truncate">
              <span>${g.name}</span>
            </div>
            <div class="text-xs text-white/90 mt-0.5">${ownerLabel}</div>
          </div>
          <div class="seal" aria-hidden="true"></div>
        </div>

        <div class="body px-4 pb-2 pt-1">
          <div class="grid grid-cols-3 gap-2 text-center">
            <div class="stat-box rounded-md p-2">
              <div class="text-[10px] text-white">${labelMembers}</div>
              <div class="num num-hero whitespace-nowrap">${g.members}</div>
            </div>
            <div class="stat-box rounded-md p-2">
              <div class="text-[10px] text-white">${labelTotal}</div>
              <div class="num num-hero whitespace-nowrap">${g.totalSent}</div>
            </div>
            <div class="stat-box rounded-md p-2">
              <div class="text-[10px] text-white">${labelPeriod}</div>
              <div class="num num-hero whitespace-nowrap">${g.periodSent}</div>
            </div>
          </div>
        </div>
      </a>`;
        })
        .join('');

      // 2. 更新頁碼 summary
      if (lang === 'en-US') {
        pageInfoEl.textContent = `${totalItems} groups (Page ${currentPage} / ${totalPages})`;
      } else {
        pageInfoEl.textContent = `共 ${totalItems} 個群組｜第 ${currentPage} / ${totalPages} 頁`;
      }

      // 3. Prev / Next 按鈕狀態
      const disablePrev = currentPage <= 1;
      const disableNext = currentPage >= totalPages;

      toggleBtn(prevBtn, disablePrev);
      toggleBtn(nextBtn, disableNext);

      // 4. tab 高亮樣式
      tabBtns.forEach((btn) => {
        const tabName = btn.getAttribute('data-tab-btn');
        const isActive = tabName === activeTab;
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');

        if (isActive) {
          btn.classList.add('bg-white', 'shadow');
          btn.classList.remove('text-black/70');
        } else {
          btn.classList.remove('bg-white', 'shadow');
          btn.classList.add('text-black/70');
        }
      });

      // 5. 更新網址 (不 reload)
      const newQS = `?tab=${activeTab}&page=${currentPage}`;
      if (location.search !== newQS) {
        history.replaceState(null, '', newQS);
      }
    }

    function toggleBtn(el, disabled) {
      if (disabled) {
        el.setAttribute('data-disabled', 'true');
        el.classList.add('opacity-50', 'pointer-events-none', 'cursor-not-allowed', 'select-none');
      } else {
        el.removeAttribute('data-disabled');
        el.classList.remove(
          'opacity-50',
          'pointer-events-none',
          'cursor-not-allowed',
          'select-none',
        );
      }
    }

    // 綁事件
    prevBtn.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        render();
        updateUrl();
      }
    });

    nextBtn.addEventListener('click', async () => {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        await render();
        updateUrl();
      }
    });

    tabBtns.forEach((btn) => {
      btn.addEventListener('click', async () => {
        const tabName = btn.getAttribute('data-tab-btn');
        if (!tabName) return;
        activeTab = tabName;
        currentPage = 1; // 切 tab 回到第 1 頁
        await render();
        updateUrl();
      });
    });

    // 搜索功能
    if (searchInput) {
      let searchTimeout;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(async () => {
          searchQuery = e.target.value.trim();
          currentPage = 1;
          await render();
          updateUrl();
        }, 300); // 防抖 300ms
      });
    }

    function updateUrl() {
      const params = new URLSearchParams();
      params.set('tab', activeTab);
      params.set('page', String(currentPage));
      if (searchQuery) {
        params.set('q', searchQuery);
      }
      const newQS = '?' + params.toString();
      if (location.search !== newQS) {
        history.replaceState(null, '', newQS);
      }
    }

    // 初始化 render
    render();
  })();
</script>
